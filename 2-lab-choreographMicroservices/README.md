# Lab 2: Building Choreographed Microservices  
[English](README.md) | [Bahasa Indonesia](README-id.md)

As a continuation of the previous workshop, in this workshop, you will do a more complex system that uses multiple microservices. You will learn how to combine synchronous and asynchronous communication as it's a commonly used pattern in building microservices.

You will build an HTTP API with Amazon API Gateway, and AWS Lambda Function. In the background, the HTTP API will dispatch events to Amazon EventBridge for backend processing. The event will be consumed by 4 other microservices represented by AWS Lambda Functions. Communication between microservices on the backend will run asynchronously by applying a choreography approach using Amazon EventBridge.

## Diagram
![Lab 2 Diagram](https://raw.githubusercontent.com/donnieprakoso/workshop-eventDrivenMicroservices/master/2-lab-choreographMicroservices/lab2-diagram.png)

## Tasks
These are the tasks that you need to complete. If at some point you are stuck, please refer to the primary reference located at `source/` folder. 

### Step 0: Prepare work folder and boto3
#### Install boto3 library
- Open your terminal
- Run this command
```bash
pip install boto3
```

#### Preparing work folder
- Navigate to `work/` folder
- You will find 2 sub-directories named `cdk` and `lambda-functions`

### Step 1: Structuring AWS Lambda Functions work folders
- Navigate to `work/lambda-functions/` folder
- You will find 5 sub-directories in this folder: 
1. `forecasting-service`
2.	`fulfilment-service`
3. `invoice-service`
4. `logistic-service`
5. `order-service`

### Step 2: Working on `order-service`
- Navigate to `work/lambda-functions/order-service`
- Open `app.py`

### Step 3: Create a function to save data
- First task in this file is to create a function to save data into Amazon DynamoDB. You only need to save 2 variables, ID and current timestamp. ID goes to `ID` field and timestamp goes to `time_order_service`.

>**💡 HINT**
>- Use `update_item()` API to save the data into DynamoDB. You can find the API reference [here](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#DynamoDB.Table.update_item).

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/lambda-functions/order-service/app.py)

### Step 4: Create a dictionary as payload data 
- First, create a dictionary to hold all data passed to Amazon EventBridge and called it `data`  
		
```python
    data = {}
    data['metadata'] = {"service": "demo-eventbridge"}
    data['data'] = {}          
    data['data']['ID'] = id		
```


### Step 5: Create a function to send event
- Next, send an event to Amazon EventBridge. 
- Don't forget to include the `data` into the `Detail` and you also need to dump it as JSON. 
- Additional info that you need to add:
	- Source: `order_service`
	- DetailType: `order_created`
	- Detail: [Need to be in JSON format]	
    - EventBusName: [Need to obtain from environment variable named: "EVENTBUS_NAME"]

>**💡 HINT**
>- You need to create a client to connect to AWS resources. On Python, you need to use boto3 library. 
>- Use put_events() API to send event to Amazon EventBridge. Here's the [link](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/events.html).
>- Use `json.dumps()` to convert your dictionary into JSON string. Here's the [info](https://docs.python.org/3/library/json.html).
>- Use `os.getenv()` to get data from environment variable.

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/lambda-functions/order-service/app.py)

### Step 6: Call save_to_db() function
- Lastly, save the data into the database by calling save_to_db() function that we have defined earlier. 
- Remember, only pass the ID. 
- The timestamp will be generated by your function. 
- Here's the code to call the function:
```python
save_to_db(id)
```
> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/lambda-functions/order-service/app.py)

### Step 7: Working on `logistic-service`
**You don't need to do anything.** This is already been provided in the `work/lambda-functions/logistic-service/app.py` file as a **partial** code. Additional tasks needs to be done after finishing Step 17.

### Step 8: Working on `invoice-service`
**You don't need to do anything.** This is already been provided in the `work/lambda-functions/invoice-service/app.py` file as a complete code.

### Step 9: Working on `fulfilment-service`
**You don't need to do anything.** This is already been provided in the `work/lambda-functions/fulfilment-service/app.py` file as a **partial** code. Additional tasks needs to be done after finishing Step 17.

### Step 10: Working on `forecasting-service`
**You don't need to do anything.** This is already been provided in the `work/lambda-functions/forecasting-service/app.py` file as a complete code.

### Step 11: Setting cdk.json
- Navigate to `work/cdk/`
- Create a file named `cdk.json`
- Open `cdk.json` and write these lines. These lines are to give a set of instruction for AWS CDK on how to build this app.
```json
{
	"app":"python3 app.py",
	"context":{}
}
```
- Open `app.py`. In this file, you see that we are missing few things to make this as a complete code. Read the file thoroughly and go to the next steps below.

### Step 12: Create EventBridge Pattern
- Create EventBridge pattern for order created.   

>**💡 HINT**
>- Use EventPattern object to create the pattern for Amazon EventBridge. Here's the [API reference](https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_events/EventPattern.html).

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/cdk/app.py)

### Step 13: Create EventBridge Rule
- Create EventBridge rule for order_created
- Add 3 targets into this rule. This way, you define how this rule should matched and sent to designated targets.

>**💡 HINT**
>- Use Rule construct to define the EventBridge rule. Here's the [API reference](https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_events/Rule.html).

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/cdk/app.py)

### Step 14: Review Amazon API GAteway Integration
- Noticed the Amazon API Gateway integration with `order_service`. It is declared with GET method and resource URI as `/order`. 

### Step 15: Install all required libraries to build and run CDK app
- Open your terminal
- Navigate to `work/cdk/`
- Create a file named `requirements.txt`. This is a standard method to install any dependencies for Python applications. 
- Add these lines:
```
aws-cdk.core==1.70.0
aws-cdk.aws-iam==1.70.0
aws-cdk.aws-lambda==1.70.0
aws-cdk.aws-apigateway==1.70.0
aws-cdk.aws-events==1.70.0
aws-cdk.aws-events-targets==1.70.0
aws-cdk.aws-dynamodb==1.70.0
```
- Install the libraries by executing:
```bash
pip install -r requirements.txt
```
### Step 16: Deploy
- Open your terminal
- Navigate to `work/cdk/`
- Deploy the app by executing:
```bash
cdk deploy
```
- When you successfully deployed the CDK APP, you will get an API endpoint running on Amazon API Gateway and integrated with `order-service` on Lambda function. **Note down this URL.**

### Step 17: Testing
- Open your web browser and navigate to the URL endpoint created with the URI path of your resource. Example: `https://<YOUR_ENDPOINT>/prod/order`
- Once it's created, you will see a message: `order_created`

![Lab 2: API Response](https://raw.githubusercontent.com/donnieprakoso/workshop-eventDrivenMicroservices/master/2-lab-choreographMicroservices/lab2-api-response.png)

- In the background, it emits an event to Amazon EventBridge and save the data into Amazon DynamoDB.

#### Let's check our DynamoDB. 
- Go to [DynamoDB dashboard](https://ap-southeast-1.console.aws.amazon.com/dynamodb/home?region=ap-southeast-1#tables:) and filter the tables with `lab2`.
- Open the table.
- You will see that a record just been created with recent timestamp for `order-service`, `invoice-service`, `fulfilment-service` and `forecasting-service`

![Lab 2: DynamoDB Test Result](https://raw.githubusercontent.com/donnieprakoso/workshop-eventDrivenMicroservices/master/2-lab-choreographMicroservices/lab2-dynamodb-1.png)

#### ⚠️ BUT WAIT, how about `logistic-service`? ⚠️
At this point, you know how to integrate Amazon EventBridge with AWS Lambda Function and how to build a CDK to provision all resources.

Next steps are optional and feel free to clean this workshop if you don't want to continue.

### Step 18: Enhancing the system to include `logistic-service`
#### Working on `fulfilment-service`
- Navigate to `work/lambda-functions/fulfilment-service/`
- Open app.py
- Complete the task to send event as `fulfilment_completed` so `logistic_service` could receive the message.

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/lambda-functions/fulfilment-service/app.py)

#### Working on `logistic-service`
- Navigate to `work/lambda-functions/logistic-service/`
- Open app.py
- Complete the task to parse the event from Amazon EventBridge
- Save the data into DynamoDB

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/lambda-functions/logistic-service/app.py)

#### Updating CDK app
- Navigate to `work/cdk/`
- Open app.py
- Find `[ADDITIONAL TASK]` and create EventBridge pattern and rule for message `fulfilment_completed`

> ### 😕 Are you stuck?
> See the solution [here](https://github.com/donnieprakoso/workshop-eventDrivenMicroservices/blob/master/2-lab-choreographMicroservices/source/cdk/app.py)

### Step 19: Redeploy the CDK App
- Open your terminal
- Navigate to `work/cdk/`
- Check the changes by running `diff`:
```bash
cdk diff
```
- Once you think it's okay, you can deploy the app by executing:
```bash
cdk deploy
```
### Step 20: Testing
- Open your web browser and navigate to the URL endpoint created with the URI path of your resource. Example: `https://<YOUR_ENDPOINT>/prod/order`
- Once it's created, you will see a message. In the background, it's firing an event to Amazon EventBridge and saving the data into Amazon DynamoDB.

#### Let's check our DynamoDB. 
- Go to [DynamoDB dashboard](https://ap-southeast-1.console.aws.amazon.com/dynamodb/home?region=ap-southeast-1#tables:) and filter the tables with `lab2`.
- Open the table.
- You will see that a record just been created with recent timestamp for `order-service`, `invoice-service`, `fulfilment-service`, `forecasting-service` and lastly `logistic-service`

![Lab 2: DynamoDB Table](https://raw.githubusercontent.com/donnieprakoso/workshop-eventDrivenMicroservices/master/2-lab-choreographMicroservices/lab2-dynamodb-2.png)

# 🤘🏻Congrats! 
You've just finished the Lab 2.

## Cleaning Up
To clean up all resources, follow these instructions below:
1. Go to `work/cdk/`
2. Run `cdk destroy` command
```bash
cdk destroy
```